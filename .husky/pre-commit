echo "ğŸ” Running pre-commit security checks..."
echo ""

# ============================================================
# CHECK 1: Detect .env files
# ============================================================
echo "ğŸ“‹ Check 1: Scanning for .env files..."

if git diff --cached --name-only | grep -E '\.env$|\.env\.|\.env_' | grep -v '.env.example' | grep -v '.env.test'; then
  echo ""
  echo "âŒ ERROR: Detected .env file in commit!"
  echo ""
  echo "   The following sensitive files are staged:"
  git diff --cached --name-only | grep -E '\.env$|\.env\.|\.env_' | grep -v '.env.example' | grep -v '.env.test' | sed 's/^/   â†’ /'
  echo ""
  echo "   These files contain sensitive credentials and should NOT be committed!"
  echo ""
  echo "   To fix:"
  echo "   1. Remove from staging: git reset HEAD <file>"
  echo "   2. Add to .gitignore if not already there"
  echo "   3. Commit without the .env file"
  echo ""
  echo "   To bypass (NOT RECOMMENDED): git commit --no-verify"
  echo ""
  exit 1
fi

echo "âœ… No .env files detected"
echo ""

# ============================================================
# CHECK 2: Detect potential secrets in diff
# ============================================================
echo "ğŸ“‹ Check 2: Scanning for potential secrets in code..."

# Patterns to detect (using grep -E format)
SECRETS_FOUND=0

# Check each pattern individually
if git diff --cached | grep -i -E "password\s*=\s*['\"][^'\"]{8,}" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: password assignment"
fi

if git diff --cached | grep -i -E "api[_-]?key\s*=\s*['\"][^'\"]{20,}" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: API key"
fi

if git diff --cached | grep -i -E "secret\s*=\s*['\"][^'\"]{20,}" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: secret assignment"
fi

if git diff --cached | grep -i -E "token\s*=\s*['\"][^'\"]{20,}" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: token"
fi

if git diff --cached | grep -i -E "DATABASE_URL\s*=\s*['\"]postgresql://[^'\"]+:[^'\"]+@" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: DATABASE_URL with credentials"
fi

if git diff --cached | grep -i -E "mongodb(\+srv)?://[^:]+:[^@]+@" > /dev/null 2>&1; then
  SECRETS_FOUND=1
  echo "   Found pattern: MongoDB URL with credentials"
fi

if [ $SECRETS_FOUND -eq 1 ]; then
  echo ""
  echo "âš ï¸  WARNING: Potential secrets detected in changes!"
fi

if [ $SECRETS_FOUND -eq 1 ]; then
  echo ""
  echo "   Please review your changes carefully!"
  echo "   If these are actual secrets, DO NOT commit them."
  echo ""
  echo "   Options:"
  echo "   1. Use environment variables instead"
  echo "   2. Use .env files (which are gitignored)"
  echo "   3. Use secret management services"
  echo ""
  echo "   To bypass this check (NOT RECOMMENDED): git commit --no-verify"
  echo ""
  exit 1
fi

echo "âœ… No secrets detected in code changes"
echo ""

# ============================================================
# CHECK 3: Verify .gitignore is protecting sensitive files
# ============================================================
echo "ğŸ“‹ Check 3: Verifying .gitignore configuration..."

MISSING_IGNORES=0

# Check for required .gitignore patterns
if ! grep -E "^\\.env$" .gitignore > /dev/null 2>&1; then
  if [ $MISSING_IGNORES -eq 0 ]; then
    echo ""
    echo "âš ï¸  WARNING: .gitignore may not be protecting all sensitive files"
    echo ""
  fi
  MISSING_IGNORES=1
  echo "   Missing pattern: .env"
fi

if ! grep -E "^\\.env\\.\\*" .gitignore > /dev/null 2>&1; then
  if [ $MISSING_IGNORES -eq 0 ]; then
    echo ""
    echo "âš ï¸  WARNING: .gitignore may not be protecting all sensitive files"
    echo ""
  fi
  MISSING_IGNORES=1
  echo "   Missing pattern: .env.*"
fi

if ! grep -E "^\\*\\.env$" .gitignore > /dev/null 2>&1; then
  if [ $MISSING_IGNORES -eq 0 ]; then
    echo ""
    echo "âš ï¸  WARNING: .gitignore may not be protecting all sensitive files"
    echo ""
  fi
  MISSING_IGNORES=1
  echo "   Missing pattern: *.env"
fi

if [ $MISSING_IGNORES -eq 1 ]; then
  echo ""
  echo "   Consider adding these patterns to .gitignore"
  echo ""
fi

echo "âœ… .gitignore check complete"
echo ""

# ============================================================
# CHECK 4: Warn about force pushes (if applicable)
# ============================================================
if [ -f ".git/MERGE_HEAD" ]; then
  echo "ğŸ“‹ Info: Merge commit detected"
fi

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… All security checks passed! Proceeding with commit...     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
