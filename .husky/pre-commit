#!/usr/bin/env sh
. "$(dirname -- "$0")/_/husky.sh"

echo "ğŸ” Running pre-commit security checks..."
echo ""

# ============================================================
# CHECK 1: Detect .env files
# ============================================================
echo "ğŸ“‹ Check 1: Scanning for .env files..."

if git diff --cached --name-only | grep -E '\.env$|\.env\.|\.env_' | grep -v '.env.example' | grep -v '.env.test'; then
  echo ""
  echo "âŒ ERROR: Detected .env file in commit!"
  echo ""
  echo "   The following sensitive files are staged:"
  git diff --cached --name-only | grep -E '\.env$|\.env\.|\.env_' | grep -v '.env.example' | grep -v '.env.test' | sed 's/^/   â†’ /'
  echo ""
  echo "   These files contain sensitive credentials and should NOT be committed!"
  echo ""
  echo "   To fix:"
  echo "   1. Remove from staging: git reset HEAD <file>"
  echo "   2. Add to .gitignore if not already there"
  echo "   3. Commit without the .env file"
  echo ""
  echo "   To bypass (NOT RECOMMENDED): git commit --no-verify"
  echo ""
  exit 1
fi

echo "âœ… No .env files detected"
echo ""

# ============================================================
# CHECK 2: Detect potential secrets in diff
# ============================================================
echo "ğŸ“‹ Check 2: Scanning for potential secrets in code..."

# Patterns to detect
SECRET_PATTERNS=(
  "password\s*=\s*['\"][^'\"]{8,}"
  "api[_-]?key\s*=\s*['\"][^'\"]{20,}"
  "secret\s*=\s*['\"][^'\"]{20,}"
  "token\s*=\s*['\"][^'\"]{20,}"
  "DATABASE_URL\s*=\s*['\"]postgresql://[^'\"]+:[^'\"]+@"
  "mongodb(\+srv)?://[^:]+:[^@]+@"
  "PRIVATE[_-]?KEY"
  "-----BEGIN.*PRIVATE KEY-----"
)

SECRETS_FOUND=0

for pattern in "${SECRET_PATTERNS[@]}"; do
  if git diff --cached | grep -i -E "$pattern" > /dev/null; then
    if [ $SECRETS_FOUND -eq 0 ]; then
      echo ""
      echo "âš ï¸  WARNING: Potential secrets detected in changes!"
      echo ""
    fi
    SECRETS_FOUND=1
    echo "   Found pattern: $pattern"
  fi
done

if [ $SECRETS_FOUND -eq 1 ]; then
  echo ""
  echo "   Please review your changes carefully!"
  echo "   If these are actual secrets, DO NOT commit them."
  echo ""
  echo "   Options:"
  echo "   1. Use environment variables instead"
  echo "   2. Use .env files (which are gitignored)"
  echo "   3. Use secret management services"
  echo ""
  echo "   To bypass this check (NOT RECOMMENDED): git commit --no-verify"
  echo ""
  exit 1
fi

echo "âœ… No secrets detected in code changes"
echo ""

# ============================================================
# CHECK 3: Verify .gitignore is protecting sensitive files
# ============================================================
echo "ğŸ“‹ Check 3: Verifying .gitignore configuration..."

REQUIRED_IGNORES=(
  "^\.env$"
  "^\.env\.\*"
  "^\*\.env$"
)

MISSING_IGNORES=0

for pattern in "${REQUIRED_IGNORES[@]}"; do
  if ! grep -E "$pattern" .gitignore > /dev/null 2>&1; then
    if [ $MISSING_IGNORES -eq 0 ]; then
      echo ""
      echo "âš ï¸  WARNING: .gitignore may not be protecting all sensitive files"
      echo ""
    fi
    MISSING_IGNORES=1
    echo "   Missing pattern: $pattern"
  fi
done

if [ $MISSING_IGNORES -eq 1 ]; then
  echo ""
  echo "   Consider adding these patterns to .gitignore"
  echo ""
fi

echo "âœ… .gitignore check complete"
echo ""

# ============================================================
# CHECK 4: Warn about force pushes (if applicable)
# ============================================================
if [ -f ".git/MERGE_HEAD" ]; then
  echo "ğŸ“‹ Info: Merge commit detected"
fi

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  âœ… All security checks passed! Proceeding with commit...     â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""
