generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String     @id @default(cuid())
  email        String     @unique
  name         String?
  passwordHash String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  username     String     @unique
  strategies   Strategy[]
}

model Transaction {
  id              String   @id @default(cuid())
  userId          String
  ticker          String
  type            String
  quantity        Float
  price           Float
  transactionDate DateTime
  fee             Float    @default(0)
  taxRate         Float    @default(0)
  calculatedPl    Float?
  notes           String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  stockAccountId  String

  @@index([userId, transactionDate])
  @@index([userId, transactionDate(sort: Desc)], map: "idx_transaction_user_date_desc")
  @@index([userId, ticker])
  @@index([userId, ticker, transactionDate(sort: Desc)], map: "idx_transaction_user_ticker_date")
  @@index([stockAccountId])
  @@index([stockAccountId, transactionDate(sort: Desc)], map: "idx_transaction_account_date")
  @@index([userId, type, transactionDate(sort: Desc)], map: "idx_transaction_user_type_date")
  @@index([userId, type, calculatedPl], map: "idx_transaction_user_type_pl")
  @@index([transactionDate(sort: Desc)], map: "idx_transaction_date_desc")
}

model JournalEntry {
  id              String   @id @default(cuid())
  transactionId   String   @unique
  userId          String
  emotionOnEntry  String?
  emotionOnExit   String?
  strategyUsed    String?
  postTradeReview String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)], map: "idx_journal_entry_user_created")
}

model Tag {
  id        String   @id @default(cuid())
  userId    String
  name      String
  createdAt DateTime @default(now())

  @@unique([userId, name])
}

model JournalEntryTag {
  journalEntryId String
  tagId          String

  @@id([journalEntryId, tagId])
}

model Strategy {
  id        String   @id @default(cuid())
  userId    String
  title     String?
  content   String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@index([createdAt(sort: Desc)])
  @@index([userId])
}

model StockPriceCache {
  id            String   @id @default(cuid())
  symbol        String   @unique
  price         Float
  lastUpdatedAt DateTime
  source        String   @default("tcbs")
  metadata      Json?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([symbol])
  @@index([lastUpdatedAt])
  @@index([symbol, lastUpdatedAt(sort: Desc)], map: "idx_stock_price_cache_symbol_updated")
}

model StockAccount {
  id            String   @id
  name          String
  brokerName    String?
  accountNumber String?
  description   String?
  userId        String
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@unique([userId, name])
  @@index([userId])
}

model PurchaseLot {
  id                String   @id @default(cuid())
  userId            String
  stockAccountId    String
  ticker            String
  purchaseDate      DateTime
  quantity          Float
  pricePerShare     Float
  totalCost         Float
  buyFee            Float    @default(0)
  remainingQuantity Float
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([userId, ticker, stockAccountId])
  @@index([purchaseDate])
}

model AccountFee {
  id              String   @id @default(cuid())
  userId          String
  stockAccountId  String
  feeType         FeeType
  amount          Float
  description     String?
  feeDate         DateTime
  referenceNumber String?
  attachmentUrl   String?
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([userId, stockAccountId])
  @@index([feeType])
  @@index([feeDate])
  @@index([userId, stockAccountId, feeDate(sort: Desc)], map: "idx_account_fee_user_account_date")
}

model CostBasisAdjustment {
  id               String         @id @default(cuid())
  userId           String
  stockAccountId   String
  ticker           String
  adjustmentType   AdjustmentType
  eventDate        DateTime
  dividendPerShare Float?
  taxRate          Float          @default(0.05)
  splitRatio       Float?
  description      String?
  externalRef      String?
  isActive         Boolean        @default(true)
  processedAt      DateTime?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  createdBy        String?

  @@index([userId, stockAccountId, ticker])
  @@index([userId, ticker, eventDate(sort: Desc)], map: "idx_adjustment_user_ticker_date")
  @@index([stockAccountId, ticker, isActive], map: "idx_adjustment_account_ticker_active")
  @@index([eventDate(sort: Desc)], map: "idx_adjustment_event_date")
}

enum FeeType {
  CUSTODY_FEE
  ADVANCE_SELLING_FEE
  ACCOUNT_MAINTENANCE
  TRANSFER_FEE
  DIVIDEND_TAX
  INTEREST_FEE
  DATA_FEED_FEE
  SMS_NOTIFICATION_FEE
  STATEMENT_FEE
  WITHDRAWAL_FEE
  OTHER_FEE
}

enum AdjustmentType {
  CASH_DIVIDEND
  STOCK_DIVIDEND
  STOCK_SPLIT
  REVERSE_SPLIT
  MERGER
  SPINOFF
}
